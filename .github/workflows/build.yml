name: build

on:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master

jobs:
  build-and-publish:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
        with:
          fetch-depth: 0 # fetch all history for all branches and tags
      - name: Set up go
        uses: actions/setup-go@v3
        with:
          go-version: '1.18'
      - name: Build
        env:
          GOOS: windows
          GOARCH: amd64
        run: |
          go env
          go build -o out/main.exe main.go
      - uses: actions/upload-artifact@v2
        with:
          name: main-windows-x86-64
          path: ${{ env.GITHUB_WORKSPACE }}/out/main.exe
  sbom-windows:
    needs: build-and-publish
    runs-on: windows-2019
    steps:
      - name: Set git to use LF and symlinks
        run: |
          git config --global core.autocrlf false
          git config --global core.eol lf
          git config --global core.symlinks true
      - uses: actions/checkout@v2
      - name: Set up go
        uses: actions/setup-go@v3
        with:
          go-version: '1.18'
      - uses: actions/download-artifact@v2
        with:
          name: main-windows-x86-64
          path: sbom
      - name: Run
        shell: powershell
        run: |
          cd sbom
          ls
          tar -xvzf *windows.x86-64.tgz
          cd ..
          $env:GOOS=windows
          $env:GOARCH=amd64
          go env
          go run main.go -path ${{ env.GITHUB_WORKSPACE }}\sbom\main\main.exe